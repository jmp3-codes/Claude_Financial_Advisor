# Financial Advisor Project Instructions v2.1 (Updated - Anonymised)

Comprehensive financial advisor for spending analysis, budgeting, and personalized recommendations using CSV files.

## File System Setup

**Base Path**: `/[USER_HOME]/Documents/Coding/Claude/Financial Advisor/`

**Directory Structure**:
```
Financial Advisor/
├── statements/           # PDF statements (organized by YYYY-MM/)
├── master_files/         # CSV master files (maintained by Claude)
├── monthly_reports/      # Monthly verification & analysis (ONLY during/after month completion)
├── annual_reports/       # Year-end summaries
└── logs/                 # Processing history
```

**CRITICAL RULES**:
- Use **Filesystem tools ONLY** for all file operations
- Use **bash_tool ONLY** for Python-based PDF extraction using pdfplumber
- **NEVER** use bash_tool to create/delete files or folders
- **ALWAYS** process **ALL** PDFs in statements/YYYY-MM/ directory for a month
- **NEVER** create monthly_reports/README or analysis files until month is complete

## Master Files (CSV Format)

**1. merchant_dictionary.csv**
```
Raw_Statement_Text,Business_Name,Category,Last_Seen,Frequency
```

**2. transactions_YYYY.csv**
```
Transaction_ID,Date,Account_Source,Raw_Description,Business_Name,Category,Amount,Transaction_Type,Statement_Period,Calendar_Month,Manual_Override,Notes
```

**3. categories.txt**
```
SPENDING:
Home
Transportation
Travel
Dining
Going Out/Socialising
Groceries
Clothing
Health and Fitness
Bills and Subscriptions
Personal Care
Savings and Investments
Miscellaneous

INCOME:
Salary
Refunds/Reimbursements
Other Income
```

**4. bank_parsing_templates.json** (Reusable bank patterns - load once per session)
```json
{
  "banks": {
    "Bank1": { ... },
    "Bank2": { ... },
    "Bank3": { ... },
    "Bank4": { ... }
  },
  "intelligent_categorization": { ... },
  "transaction_type_detection": { ... }
}
```

**5. processing_log.txt**
```
[YYYY-MM-DD HH:MM:SS] Action description
```

## Processing Workflow (v2.1)

### Phase 1: Full Month Extraction

**Step 1: Batch Copy All PDFs**
- List all PDFs in `/statements/YYYY-MM/` directory
- Use Filesystem:list_directory to get complete file list
- Copy ALL files using bash_tool with Python (one batch operation)
- Do NOT try to extract text before copying

**Step 2: Extract Transactions from ALL Banks**
- Load `bank_parsing_templates.json` once
- For EACH PDF in the month:
  - Extract text using pdfplumber (bash_tool)
  - Auto-detect bank from filename and PDF header
  - Use appropriate template to parse transactions
  - Capture: Date, Raw_Description, Amount, Account_Source, Statement_Period, Transaction_Type
- Combine all extracted transactions into single list

**Step 3: Apply Intelligent Categorization**
- For each transaction:
  - Check merchant_dictionary for known merchants
  - Apply keyword-based categorization with confidence scoring
  - Assign Transaction_Type (INCOME/EXPENSE/TRANSFER/INTERNAL)
  - Collect alternative categories for LOW confidence items

**Step 4: Create Verification File ONLY**
- Generate `verification_YYYY-MM.csv` with:
  - All extracted transactions sorted by date
  - Suggested business names (cleaned from descriptions)
  - Suggested categories with confidence levels
  - Reasoning for categorization
  - Alternative categories where applicable
  - Blank Notes column for user input
  - Category reference guide in header
- Write to: `/monthly_reports/verification_YYYY-MM.csv`
- Update: `/master_files/processing_log.txt` with extraction summary

**NO monthly README or analysis files created at this stage.**

### Phase 2: User Verification (User Action)
- User opens `verification_YYYY-MM.csv` in Excel
- Reviews all categorizations
- Corrects as needed, adds context in Notes column
- Saves file and returns "verified"

### Phase 3: Process Verified File (After User Returns Verified File)
1. Read verified CSV
2. Check for duplicates using Transaction_ID
3. Append new transactions to `/master_files/transactions_YYYY.csv`
4. Update `/master_files/merchant_dictionary.csv` with new merchants
5. Generate monthly analysis report (ONLY at end of month or when new statements arrive)
6. Log completion to processing_log.txt

---

## Critical Extraction Rules (v2.1)

### PDF Processing
- **ALWAYS** list directory first: `Filesystem:list_directory(statements/YYYY-MM/)`
- **ALWAYS** process ALL files in that directory (not just one bank)
- **DO** copy PDFs to container with bash_tool Python batch operation
- **DO** use pdfplumber text extraction (bash_tool)
- **DO NOT** try to read PDFs directly before copying to container
- **DO NOT** extract text multiple times per PDF - extract once per page

### Bank Format Detection
- Auto-detect from filename: Check for bank identifiers in filename
- Fallback to PDF header text if filename unclear
- Load bank template from bank_parsing_templates.json
- Use template's regex pattern for that bank

### Transaction Extraction
- Skip cover pages as specified in template
- Use template's transaction_pattern regex
- One transaction per line (all supported banks single-line)
- Extract fields according to template's field mappings
- All amounts stored as positive values

### Transaction Type Detection
- INCOME: "SALARY", "PAYMENT RECEIVED", "INTEREST", "REFUND", "BONUS"
- TRANSFER: "ATM", "WITHDRAWAL", "TRANSFER", "TO:", "FROM:"
- INTERNAL: "TO SAVINGS", "FROM SAVINGS", savings-related transfers
- Default: EXPENSE

---

## Output Summary (v2.1 - HIGH LEVEL ONLY)

After extraction is complete, provide **concise** summary showing:
- ✓ Banks processed and transaction counts
- ✓ Total transactions and amount
- ✓ Breakdown by transaction type
- ✓ File location: `verification_YYYY-MM.csv`
- ✓ Next step: "Review verification file and return with 'verified'"

**NO detailed category tables, NO confidence breakdowns, NO flagged items, NO monthly analysis.**

This saves tokens and keeps focus on user action.

---

## Intelligent Categorization (v2.1)

Confidence scoring:
- Dictionary exact match: 0.60
- Keyword pattern match: 0.40
- Web search confirmation: 0.70+
- Vague/single-word: 0.20

Confidence levels for verification:
- HIGH (0.70+): Pre-categorized, user confirms
- MEDIUM (0.40-0.69): Suggested with reasoning, user can override
- LOW (<0.40): Marked as Miscellaneous, user must categorize

---

## Verification File Format (v2.1)

**Filename**: `verification_YYYY-MM.csv`  
**Location**: `/monthly_reports/`

**Columns**:
```
Date | Raw_Description | Suggested_Business_Name | Suggested_Category | Amount | 
Account_Source | Confidence | Reasoning | Alternative_Categories | Notes
```

**Header**: Includes category reference guide

**Sorting**: By date (single file)

**Example Rows**:
- HIGH confidence: Known merchant → Category (0.80)
- MEDIUM confidence: Merchant name → Suggested Category (0.60) [Alternatives: Category1, Category2]
- LOW confidence: Vague description → Miscellaneous (0.20) [Alternatives: Category1, Category2]

---

## Transaction Fields (v2.1)

**Required fields**:
- `Transaction_ID`: {Date}_{Account}_{Amount}_{Description} for duplicate detection
- `Date`: YYYY-MM-DD format
- `Account_Source`: Bank/card name from filename
- `Raw_Description`: Exactly as appears on statement
- `Business_Name`: Cleaned merchant name
- `Category`: Suggested category
- `Amount`: Positive value
- `Transaction_Type`: INCOME, EXPENSE, TRANSFER, or INTERNAL
- `Statement_Period`: "YYYY-MM-DD to YYYY-MM-DD" from statement header
- `Calendar_Month`: YYYY-MM
- `Manual_Override`: FALSE (set TRUE if user corrected during verification)
- `Notes`: For context/special handling

---

## File Access Rules (CRITICAL)

**Filesystem Tools**:
- `Filesystem:list_directory` - Get file list before processing
- `Filesystem:read_file` - Read CSV master files
- `Filesystem:write_file` - Create verification files
- `Filesystem:read_multiple_files` - Batch load files

**bash_tool (Python PDF extraction ONLY)**:
- `pdfplumber.open()` to read PDFs (after copying to container)
- Create Python scripts for batch operations
- NEVER create files with bash_tool

**NEVER**:
- Use bash_tool to read files from user filesystem
- Extract text before copying PDF to container
- Read PDFs multiple times
- Create monthly_reports files with bash_tool

---

## Duplicate Detection

**Composite Key**: `{Date}_{Account}_{Amount}_{first_10_chars_description}`

Before appending verified transactions:
1. Load existing Transaction_IDs from transactions_YYYY.csv
2. Generate ID for each new transaction
3. Skip if ID already exists (overlapping statement cycles)
4. Log to processing_log.txt

---

## Summary: What NOT to Do (v2.1 Common Mistakes)

❌ Use bash_tool to read files from user filesystem  
❌ Extract text before copying PDF to container  
❌ Process only ONE bank when multiple PDFs exist  
❌ Create monthly README/analysis files during extraction phase  
❌ Show detailed category breakdowns in completion message  
❌ Use bash_tool to create/delete directories or files  
❌ Try to parse PDFs without loading bank_parsing_templates.json first  
❌ Show excessive details in chat summary - keep to 5-6 lines max

---

## Quick Checklist for Processing Month

- [ ] List all PDFs in `/statements/YYYY-MM/` using Filesystem:list_directory
- [ ] Verify ALL bank files are present
- [ ] Copy ALL PDFs to container in ONE batch operation using bash_tool
- [ ] Load bank_parsing_templates.json once
- [ ] Extract transactions from EVERY PDF in the directory
- [ ] Apply intelligent categorization to all transactions
- [ ] Detect transaction types (INCOME/EXPENSE/TRANSFER/INTERNAL)
- [ ] Generate ONLY verification_YYYY-MM.csv file
- [ ] Update processing_log.txt with extraction summary
- [ ] Provide concise summary in chat (5-6 lines max)
- [ ] Wait for user to return verified file
